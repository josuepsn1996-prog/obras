<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Obras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .popup-img {
      width: 100px;
      margin: 5px;
      border-radius: 5px;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTVquIVeEYYM5fRrXHolxm1n4u0J52SxYoQEcXw9AGcyVNeugMCsxuWmOZJYtVXXYdgcryMtm1OQDkj/pub?gid=1770483882&single=true&output=csv";

    const map = L.map('map').setView([23.6345, -102.5528], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const iconUrls = {
      red: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      orange: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
      yellow: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
      green: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'
    };

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          if (!row.lat || !row.lon) return;

          const lat = parseFloat(row.lat);
          const lon = parseFloat(row.lon);
          if (isNaN(lat) || isNaN(lon)) return;

          // FOTOS CON FECHAS
          let fotos = "";
          if (row.avance_fotos) {
            const grupos = row.avance_fotos.split("||").map(s => s.trim());
            fotos = "<b>Fotos por fecha:</b><br>" + grupos.map(grupo => {
              const [fecha, urlsRaw] = grupo.split("|").map(s => s.trim());
              if (!urlsRaw) return "";

              const fotosHtml = urlsRaw.split(/[\s;]/).map(url => {
                url = url.trim();
                // Convertir enlaces de Google Drive si es necesario
                if (url.includes("drive.google.com") && url.includes("open?id=")) {
                  const id = url.split("open?id=")[1];
                  url = `https://drive.google.com/uc?export=view&id=${id}`;
                } else if (url.includes("drive.google.com/file/d/")) {
                  const id = url.split("file/d/")[1].split("/")[0];
                  url = `https://drive.google.com/uc?export=view&id=${id}`;
                }

                return `
                  <a href="${url}" target="_blank">
                    <img src="${url}" class="popup-img">
                  </a>
                `;
              }).join("");

              return `<details><summary>${fecha}</summary>${fotosHtml}</details>`;
            }).join("");
          }

          const contenido = `
            <b>${row.nombre}</b><br>
            <b>Programa:</b> ${row.programa}<br>
            <b>Municipio:</b> ${row.municipio}<br>
            <b>Localidad:</b> ${row.localidad}<br>
            <b>Tipo:</b> ${row.tipo}<br>
            <b>Presupuesto:</b> ${row.presupuesto}<br>
            <b>Contratista:</b> ${row.contratista}<br>
            <b>Inicio:</b> ${row.inicio}<br>
            <b>Fin programado:</b> ${row.fin_programado}<br>
            <b>Estatus:</b> ${row.estatus}<br>
            <b>Avance:</b> ${row.avance || 0}%<br>
            <b>Actualizado el:</b> ${row.actualizado_el}<br>
            ${fotos}
            ${row.ficha_url ? `<br><a href="${row.ficha_url}" target="_blank">Ver ficha técnica</a>` : ""}
          `;

          let avance = parseFloat(row.avance);
          let color = "red";
          if (avance > 75) color = "green";
          else if (avance > 50) color = "yellow";
          else if (avance > 25) color = "orange";

          const icono = new L.Icon({
            iconUrl: iconUrls[color],
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
          });

          L.marker([lat, lon], { icon: icono }).addTo(map).bindPopup(contenido);
        });
      }
    });
  </script>
</body>
</html>
